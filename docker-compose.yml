services:
  nginx:
    image: nginx:alpine
    ports:
      - "1080:80"
    # Para usar puerto 80: sudo sysctl -w net.ipv4.ip_unprivileged_port_start=80
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - web
    restart: unless-stopped

  backend:
    build:
      context: ./backend
    expose:
      - "8080"
    environment:
      - PORT=8080
      - SQLITE_PATH=/data/maqzone.db
      - NGROK_URL=${NGROK_URL:-https://margert-undelirious-unprefixally.ngrok-free.dev}
      - CORS_ALLOWED_ORIGINS=http://localhost,http://localhost:8000,http://localhost:1080,${NGROK_URL:-https://margert-undelirious-unprefixally.ngrok-free.dev}
      - CORS_ALLOW_ALL=false
      - ADMIN_TOKEN=change_me_please
      - JWT_SECRET=maqzone-dev-jwt-secret
    volumes:
      - sqlite-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  web:
    build:
      context: .
      target: dev
    expose:
      - "3000"
    environment:
      - NODE_ENV=development
      - API_BASE=http://backend:8080
      - NGROK_URL=${NGROK_URL:-https://margert-undelirious-unprefixally.ngrok-free.dev}
      - NEXT_PUBLIC_API_BASE=${NGROK_URL:-https://margert-undelirious-unprefixally.ngrok-free.dev}
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next          # evita que el .next local interfiera con el del contenedor
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  sqlite-data:
